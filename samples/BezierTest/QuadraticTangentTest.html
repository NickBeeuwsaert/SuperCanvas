<!DOCTYPE html>
<html>
<head>
<title>Bezier Slopes test!</title>
<script src="https://raw.github.com/r4z0rw0lf/SuperCanvas/master/superCanvas.js"></script>
<style>
html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
}
form {
    position: absolute;
    overflow: hidden;
    bottom: 0;
    right: 0;
    margin-left: -30px;
    margin-right: 10px;
    margin-bottom: 10px;
    background-color: hsla(0, 0%, 70%, 0.5);
    border: 1px solid hsla(0, 0%, 70%, 1);
    border-radius: 10px;
    padding: 5px;
}
form div div {
    clear: both;
    width:60px;display:inline-block;
}
</style>
</head>
<body>
    <canvas width="500" height="500">
    </canvas>
    <form>
        <div><div><label for="bounce">Bounce: </label></div><input type="checkbox" id="bounce" name="bounce"/></div>
        <div><div><label for="speed">Speed: </label></div><input type="range" id="speed" name="speed" min="0.001" max="0.03" step="0.001"/></div>
    </form>

    <script>
        var distance = function(x1, y1, x2, y2){
            return Math.sqrt(Math.pow(y1-y2,2)+Math.pow(x1-x2,2));
        };
        var canvas = document.querySelector("canvas");
        var context = superCanvas(canvas);
        var speed = document.querySelector("#speed");
        var bounce = document.querySelector("#bounce");

        var path = [];
        path.push(["L", 250, 0]);
        path.push(["L", 50, 500]);
        path.push(["Q", 100, 450, 250, 450]);

        path = path.concat(superCanvas.reversePath(superCanvas.bakeMatrixIntoPath(superCanvas.Matrix().translate(500,0).scale(-1, 1), path)));
        path = superCanvas.bakeMatrixIntoPath(superCanvas.Matrix().scale(50/500, 50/500).rotate(Math.PI/2).translate(-250,-250), path);

        var p0 = [10, 25];
        var p1 = [500-10, 10];
        var p2 = [10, 500-10];
        var points = [p0, p1, p2];
        var draw = function(t){
            //canvas.width+=0;
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;

            context.webkitImageSmoothingEnabled = false;
            context.mozImageSmoothingEnabled = false;

            context.lineWidth=5;
            context.beginPath();
            context.moveTo(p0[0], p0[1]);
            context.quadraticCurveTo(p1[0], p1[1], p2[0], p2[1]);

            context.stroke();
            context.closePath();

            context.lineWidth = 1;
            context.strokeStyle="#4f80ff";
            var x = superCanvas.bezierQuadraticFunction(p0[0],p1[0],p2[0], t);
            var y = superCanvas.bezierQuadraticFunction(p0[1],p1[1],p2[1], t);
            var angle = superCanvas.getQuadraticSlope(p0, p1, p2, t, true);

            context.beginPath();
            context.moveTo(p0[0], p0[1]);
            context.quadraticCurveTo(p1[0], p1[1], p2[0], p2[1]);

            context.stroke();
            context.closePath();

            context.beginPath();
            context.moveTo(p0[0],p0[1]);
            context.lineTo(p1[0],p1[1]);

            context.lineTo(p2[0],p2[1]);
            context.stroke();
            context.closePath();

            for(var i = 0; i < points.length; i++){
                context.fillStyle=!(i==1)?"white":"#4f80ff";
                context.strokeRect(points[i][0]-2.5, points[i][1]-2.5 ,5, 5);
                context.fillRect(points[i][0]-2.5, points[i][1]-2.5 ,5, 5);
            }
            context.fillRect(x-2.5,y-2.5,5,5);
            context.fillStyle="rgba("+[0x4F, 0x80, 0xFF, 0.5].join(',')+")"; //"#4f80ff";
            context.beginPath();
            context.drawPath(path, superCanvas.Matrix().translate(x,y).rotate(angle));
            context.stroke();
            context.fill();
            context.closePath();
        };
        var mousedown = false;
        var pointIndex = 0;
        canvas.addEventListener("mousedown", function(e){
            mousedown = true;
            var x = e.clientX;
            var y = e.clientY;
            pointIndex = false;
            for(var i = 0; i < points.length; i++){
                var d = distance(points[i][0],points[i][1], x,y);
                //console.log(d);
                if(d < 6){
                    pointIndex = i;
                }
            }
            //console.log("");
        });
        canvas.addEventListener("mouseup", function(){
            mousedown = false;
        });
        canvas.addEventListener("mousemove", function(e){
            if(!mousedown || pointIndex === false) return;
            var x = e.clientX;
            var y = e.clientY;
            points[pointIndex][0]=x;
            points[pointIndex][1]=y;
        });
        var go = function(){
            var t = 0;
            var d = 1;
            function a(){
                //t = bounce.checked?t%1:1-Math.abs((t%2)-1);
                if(t > 1 || t < 0){
                    d *= -1;
                }
                t = !bounce.checked?t%1:1-Math.abs((t%2)-1);
                draw(t);
                //console.log()
                /*if(t > 1)
                    t=0;*/
                setTimeout(a, 1000/60)
                t+=parseFloat(speed.value)*d;
            };
            a();
        };
        go();
    </script>
</body>
</html>
